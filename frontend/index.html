<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plant N Boom â€¢ Mijn bomen</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    body { margin:0; font:16px system-ui, -apple-system, Segoe UI, Roboto; }
    header { padding:12px 16px; border-bottom:1px solid #eee; }
    form { display:flex; gap:8px; flex-wrap:wrap; }
    input[type="text"]{ padding:8px 10px; min-width:260px; border:1px solid #ccc; border-radius:8px; }
    button{ padding:8px 14px; border:0; border-radius:8px; background:#0a7b66; color:white; cursor:pointer; }
    #map { height: calc(100vh - 70px); }
    #msg { padding:8px 16px; color:#555; }
  </style>
</head>
<body>
  <header>
    <form id="finder">
      <input id="email" type="text" placeholder="jouw e-mail of user_id" />
      <button type="submit">toon mijn bomen</button>
      <span id="msg"></span>
    </form>
  </header>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

<script>
  const map = L.map('map').setView([8.5, -13.2], 7); // Sierra Leone start
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markers = L.layerGroup().addTo(map);
  const msg = document.getElementById('msg');

  async function fetchTrees(query) {
    const baseUrl = "https://ptb-tree-map.onrender.com/api/trees";
    const url = new URL(baseUrl);

    if (query.includes('@')) {
      url.searchParams.set('email', query.trim());
    } else {
      url.searchParams.set('user_id', query.trim());
    }

    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('serverfout ' + res.status);
    return res.json();
  }

  function renderTrees(rows) {
  markers.clearLayers();
  if (!rows.length) { 
    msg.textContent = '0 bomen gevonden'; 
    return; 
  }

  const bounds = [];
  rows.forEach(r => {
    const lat = parseFloat(r.lat);
    const lng = parseFloat(r.long);

    console.log("Row:", r); // ðŸ‘ˆ log the whole row
    console.log("Parsed coords:", lat, lng); // ðŸ‘ˆ log parsed coords

    if (isNaN(lat) || isNaN(lng)) {
      console.warn("Skipping invalid coords:", r);
      return;
    }

    const m = L.marker([lat, lng]).bindPopup(
      `<strong>${r.tree_code || 'boom'}</strong><br>` +
      `${r.tree_type || ''}<br>` +
      `${r.area || ''}<br>` +
      `${r.planted_date ? new Date(r.planted_date).toLocaleDateString() : ''}`
    );
    markers.addLayer(m);
    bounds.push([lat, lng]);
  });

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [20,20] });
    console.log("Fitted map to bounds:", bounds); // ðŸ‘ˆ log bounds
  }

  msg.textContent = `${rows.length} bomen`;
}

document.getElementById('finder').addEventListener('submit', async e => {
  e.preventDefault();
  const q = document.getElementById('email').value.trim();
  if (!q) { msg.textContent = 'voer e-mail of user_id in'; return; }
  msg.textContent = 'ladenâ€¦';
  try {
    const data = await fetchTrees(q);
    console.log("API response:", data);

    // âœ… handle both `data.rows` and plain array
    const rows = Array.isArray(data) ? data : (data.rows || []);
    renderTrees(rows);

  } catch (err) {
    console.error(err);
    msg.textContent = 'kan bomen niet laden';
  }
});

</script>

</body>
</html>
